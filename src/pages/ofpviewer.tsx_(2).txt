import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useAuth } from '@/lib/auth';
import DashboardLayout from '@/components/DashboardLayout';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { ScrollArea } from '@/components/ui/scroll-area';
import { 
  Plane, 
  ArrowLeft, 
  RefreshCw, 
  Map, 
  Fuel, 
  CloudRain, 
  List, 
  Info, 
  FileText, 
  Download, 
  ExternalLink,
  Navigation,
  Weight,
  Clock,
  Gauge,
  Wind,
  ThermometerSun,
  MapPin,
  Layers,
  ImageIcon,
  Save,
  Check
} from 'lucide-react';
import { useSimBriefOFP, OFPData, OFPNavlogFix } from '@/hooks/useSimBriefOFP';
import { useSaveFlightPlan } from '@/hooks/useSaveFlightPlan';
import { getPendingOFP } from '@/lib/simbrief';
import { supabase } from '@/integrations/supabase/client';
import { MetarWeatherCard } from '@/components/ofp/MetarWeatherCard';
import { FlightRouteMap } from '@/components/ofp/FlightRouteMap';

export default function OFPViewer() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { ofpData, loading, error, fetchOFPById, fetchOFPByPid } = useSimBriefOFP();
  const { saveFlightPlan, checkIfSaved, saving } = useSaveFlightPlan();
  const [activeTab, setActiveTab] = useState('overview');
  const [imageErrors, setImageErrors] = useState<Record<number, boolean>>({});
  const [isSaved, setIsSaved] = useState(false);
  
  const ofpId = searchParams.get('ofp_id');
  const deliveryId = searchParams.get('delivery_id');
  
  useEffect(() => {
    if (ofpId) {
      console.log('Fetching OFP by ID:', ofpId);
      fetchOFPById(ofpId);
      // Check if already saved
      checkIfSaved(ofpId).then(setIsSaved);
    }
  }, [ofpId, fetchOFPById, checkIfSaved]);

  const handleSaveFlightPlan = async () => {
    if (!ofpData || !ofpId) return;
    const result = await saveFlightPlan(ofpData, ofpId, deliveryId);
    if (result) {
      setIsSaved(true);
    }
  };
  
  const formatTime = (seconds: string | null) => {
    if (!seconds) return 'N/A';
    const totalMins = parseInt(seconds) / 60;
    const hrs = Math.floor(totalMins / 60);
    const mins = Math.round(totalMins % 60);
    return `${hrs}h ${mins}m`;
  };
  
  const formatWeight = (kg: string | null) => {
    if (!kg) return 'N/A';
    return `${parseInt(kg).toLocaleString()} kg`;
  };
  
  const handleContinueToDeliveries = async () => {
    if (deliveryId) {
      await supabase
        .from('deliveries')
        .update({ simbrief_generated: true })
        .eq('id', deliveryId);
    }
    
    sessionStorage.removeItem('selectedAircraft');
    sessionStorage.removeItem('selectedContract');
    sessionStorage.removeItem('selectedCargoItems');
    sessionStorage.removeItem('totalCargoWeight');
    
    navigate('/dashboard/deliveries');
  };

  const handleImageError = (index: number) => {
    setImageErrors(prev => ({ ...prev, [index]: true }));
  };
  
  if (!user) {
    navigate('/auth');
    return null;
  }
  
  return (
    <DashboardLayout>
      {/* Header */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
        <div className="flex items-center gap-4">
          <Button 
            variant="outline" 
            size="sm" 
            onClick={() => navigate('/dashboard/deliveries')}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
          {ofpData && (
            <div>
              <h1 className="text-xl font-bold flex items-center gap-2">
                <Plane className="h-5 w-5 text-primary" />
                Operational Flight Plan
              </h1>
              <p className="text-sm text-muted-foreground">
                AFLV Cargo • Digital Dispatch System
              </p>
            </div>
          )}
        </div>
        <div className="flex items-center gap-2">
          {ofpData && ofpId && (
            <Button 
              variant={isSaved ? "secondary" : "default"}
              size="sm" 
              onClick={handleSaveFlightPlan} 
              disabled={saving || isSaved}
            >
              {isSaved ? (
                <>
                  <Check className="h-4 w-4 mr-2" />
                  Saved
                </>
              ) : (
                <>
                  <Save className="h-4 w-4 mr-2" />
                  {saving ? 'Saving...' : 'Save Plan'}
                </>
              )}
            </Button>
          )}
          {ofpId && (
            <Button 
              variant="outline" 
              size="sm" 
              onClick={() => fetchOFPById(ofpId)} 
              disabled={loading}
            >
              <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
              Refresh
            </Button>
          )}
        </div>
      </div>
      
      {loading && (
        <div className="space-y-4">
          <Skeleton className="h-32 w-full rounded-xl" />
          <Skeleton className="h-12 w-full rounded-lg" />
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <Skeleton className="h-64 w-full rounded-xl" />
            <Skeleton className="h-64 w-full rounded-xl" />
          </div>
        </div>
      )}
      
      {error && (
        <Card className="border-destructive bg-destructive/5">
          <CardContent className="p-6">
            <div className="flex items-center gap-3 text-destructive">
              <Info className="h-5 w-5" />
              <div>
                <p className="font-semibold">Error loading flight plan</p>
                <p className="text-sm">{error}</p>
              </div>
            </div>
            <div className="mt-4 flex gap-2">
              <Button 
                variant="outline" 
                onClick={() => navigate('/dashboard/ofp-generator')}
              >
                Generate New Flight Plan
              </Button>
              {ofpId && (
                <Button 
                  variant="destructive" 
                  onClick={() => fetchOFPById(ofpId)}
                >
                  Try Again
                </Button>
              )}
            </div>
          </CardContent>
        </Card>
      )}
      
      {!loading && !error && !ofpData && !ofpId && (
        <Card>
          <CardContent className="p-8 text-center">
            <Plane className="h-16 w-16 mx-auto text-muted-foreground mb-4" />
            <h2 className="text-xl font-semibold mb-2">No Flight Plan Loaded</h2>
            <p className="text-muted-foreground mb-6 max-w-md mx-auto">
              Start by selecting cargo and generating a flight plan using SimBrief.
            </p>
            <Button onClick={() => navigate('/dashboard/cargo')}>
              Select Cargo & Generate OFP
            </Button>
          </CardContent>
        </Card>
      )}
      
      {ofpData && (
        <>
          {/* Flight Summary Header - Aeroflot themed */}
          <Card className="mb-6 overflow-hidden border-0 bg-gradient-to-r from-primary to-primary/80">
            <CardContent className="p-6 text-primary-foreground">
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 sm:gap-4">
                <div className="bg-white/10 backdrop-blur-sm rounded-lg sm:rounded-xl p-2 sm:p-4 text-center">
                  <p className="text-[10px] sm:text-xs opacity-80 uppercase tracking-wide mb-1">Flight</p>
                  <p className="font-bold text-sm sm:text-xl truncate">
                    {ofpData.atc.callsign || ofpData.general.flight_number || 'N/A'}
                  </p>
                </div>
                <div className="bg-white/10 backdrop-blur-sm rounded-lg sm:rounded-xl p-2 sm:p-4 text-center">
                  <p className="text-[10px] sm:text-xs opacity-80 uppercase tracking-wide mb-1">Route</p>
                  <p className="font-bold text-sm sm:text-xl">
                    {ofpData.origin.icao_code} → {ofpData.destination.icao_code}
                  </p>
                </div>
                <div className="bg-white/10 backdrop-blur-sm rounded-lg sm:rounded-xl p-2 sm:p-4 text-center">
                  <p className="text-[10px] sm:text-xs opacity-80 uppercase tracking-wide mb-1">Aircraft</p>
                  <p className="font-bold text-sm sm:text-xl">{ofpData.aircraft.icaocode || 'N/A'}</p>
                  <p className="text-[10px] sm:text-xs opacity-70 hidden sm:block">{ofpData.aircraft.reg || ''}</p>
                </div>
                <div className="bg-white/10 backdrop-blur-sm rounded-lg sm:rounded-xl p-2 sm:p-4 text-center">
                  <p className="text-[10px] sm:text-xs opacity-80 uppercase tracking-wide mb-1">Distance</p>
                  <p className="font-bold text-sm sm:text-xl">{ofpData.general.air_distance} NM</p>
                </div>
                <div className="bg-white/10 backdrop-blur-sm rounded-lg sm:rounded-xl p-2 sm:p-4 text-center col-span-2 sm:col-span-1">
                  <p className="text-[10px] sm:text-xs opacity-80 uppercase tracking-wide mb-1">Flight Time</p>
                  <p className="font-bold text-sm sm:text-xl">{formatTime(ofpData.times.est_time_enroute)}</p>
                </div>
              </div>
            </CardContent>
          </Card>
          
          {/* Tabs Navigation */}
          <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
            <ScrollArea className="w-full pb-2">
              <TabsList className="w-full flex justify-start bg-muted/50 p-1 rounded-xl mb-6 gap-1 min-w-max">
                <TabsTrigger value="overview" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <Navigation className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">Overview</span>
                </TabsTrigger>
                <TabsTrigger value="route" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <MapPin className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">Route</span>
                </TabsTrigger>
                <TabsTrigger value="fuel" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <Fuel className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">Fuel</span>
                </TabsTrigger>
                <TabsTrigger value="weather" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <CloudRain className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">Weather</span>
                </TabsTrigger>
                <TabsTrigger value="navlog" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <List className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">NavLog</span>
                </TabsTrigger>
                <TabsTrigger value="maps" className="flex-1 min-w-0 gap-1.5 px-3 py-2 data-[state=active]:bg-background rounded-lg text-xs sm:text-sm">
                  <Map className="h-4 w-4 flex-shrink-0" />
                  <span className="truncate">Maps</span>
                </TabsTrigger>
              </TabsList>
            </ScrollArea>
            
            {/* Overview Tab */}
            <TabsContent value="overview" className="space-y-6 mt-0">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Flight Information */}
                <Card className="border-l-4 border-l-primary">
                  <CardHeader className="pb-3">
                    <CardTitle className="flex items-center gap-2 text-lg">
                      <Navigation className="h-5 w-5 text-primary" />
                      Flight Information
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <DataRow label="Departure" value={`${ofpData.origin.icao_code} - ${ofpData.origin.name}`} />
                    <DataRow label="Arrival" value={`${ofpData.destination.icao_code} - ${ofpData.destination.name}`} />
                    <DataRow label="Alternate" value={ofpData.alternate.icao_code ? `${ofpData.alternate.icao_code} - ${ofpData.alternate.name}` : 'N/A'} />
                    <DataRow label="Distance" value={`${ofpData.general.air_distance} NM`} />
                    <DataRow label="Flight Time" value={formatTime(ofpData.times.est_time_enroute)} highlight />
                    <DataRow label="Departure Runway" value={ofpData.origin.plan_rwy || 'N/A'} />
                    <DataRow label="Arrival Runway" value={ofpData.destination.plan_rwy || 'N/A'} />
                  </CardContent>
                </Card>
                
                {/* Performance Data */}
                <Card className="border-l-4 border-l-primary">
                  <CardHeader className="pb-3">
                    <CardTitle className="flex items-center gap-2 text-lg">
                      <Gauge className="h-5 w-5 text-primary" />
                      Performance Data
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <DataRow label="Cruise Altitude" value={`FL${ofpData.general.initial_altitude}`} highlight />
                    <DataRow label="Aircraft Type" value={ofpData.aircraft.name || ofpData.aircraft.icaocode} />
                    <DataRow label="Registration" value={ofpData.aircraft.reg || 'N/A'} />
                    <DataRow label="Cost Index" value={ofpData.general.costindex || 'N/A'} />
                    <DataRow label="Cruise Speed" value={`M${ofpData.general.cruise_mach} / ${ofpData.general.cruise_tas} kts`} />
                    <DataRow label="Average Wind" value={`${ofpData.general.avg_wind_dir}° / ${ofpData.general.avg_wind_spd} kts`} />
                  </CardContent>
                </Card>
              </div>

              {/* Quick Fuel & Weight Summary */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <QuickStatCard 
                  icon={Fuel} 
                  label="Block Fuel" 
                  value={formatWeight(ofpData.fuel.plan_ramp)} 
                  color="text-amber-500" 
                />
                <QuickStatCard 
                  icon={Weight} 
                  label="Est. TOW" 
                  value={formatWeight(ofpData.weights.est_tow)} 
                  color="text-blue-500" 
                />
                <QuickStatCard 
                  icon={Clock} 
                  label="Enroute Time" 
                  value={formatTime(ofpData.times.est_time_enroute)} 
                  color="text-green-500" 
                />
                <QuickStatCard 
                  icon={Navigation} 
                  label="Distance" 
                  value={`${ofpData.general.air_distance} NM`} 
                  color="text-purple-500" 
                />
              </div>
            </TabsContent>
            
            {/* Route Tab */}
            <TabsContent value="route" className="space-y-6 mt-0">
              {/* Flight Route Map */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Map className="h-5 w-5 text-primary" />
                    Flight Route Map
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <FlightRouteMap
                    navlog={ofpData.navlog}
                    origin={ofpData.origin}
                    destination={ofpData.destination}
                  />
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <MapPin className="h-5 w-5 text-primary" />
                    Flight Plan Route
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="bg-muted/50 rounded-xl p-4 font-mono text-sm break-all border-l-4 border-primary">
                    {ofpData.general.route || 'No route data available'}
                  </div>
                </CardContent>
              </Card>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Route Details</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-2 gap-3">
                      <DataBox label="Departure SID" value={ofpData.general.sid_ident || 'N/A'} />
                      <DataBox label="Arrival STAR" value={ofpData.general.star_ident || 'N/A'} />
                      <DataBox label="Air Distance" value={`${ofpData.general.air_distance} NM`} />
                      <DataBox label="GC Distance" value={`${ofpData.general.gc_distance} NM`} />
                    </div>
                  </CardContent>
                </Card>
                
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">ATC Flight Plan</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <ScrollArea className="h-32">
                      <div className="bg-muted/50 rounded-lg p-3 font-mono text-xs break-all whitespace-pre-wrap">
                        {ofpData.atc.flightplan_text || 'No ATC flight plan data'}
                      </div>
                    </ScrollArea>
                  </CardContent>
                </Card>
              </div>
            </TabsContent>
            
            {/* Fuel & Weights Tab */}
            <TabsContent value="fuel" className="space-y-6 mt-0">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Fuel Planning */}
                <Card className="border-l-4 border-l-amber-500">
                  <CardHeader className="pb-3">
                    <CardTitle className="flex items-center gap-2 text-lg">
                      <Fuel className="h-5 w-5 text-amber-500" />
                      Fuel Planning
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <DataRow label="Trip Fuel" value={formatWeight(ofpData.fuel.enroute_burn)} />
                    <DataRow label="Contingency" value={formatWeight(ofpData.fuel.contingency)} />
                    <DataRow label="Alternate" value={formatWeight(ofpData.fuel.alternate_burn)} />
                    <DataRow label="Reserve" value={formatWeight(ofpData.fuel.reserve)} />
                    <DataRow label="Extra" value={formatWeight(ofpData.fuel.extra)} />
                    <DataRow label="Taxi" value={formatWeight(ofpData.fuel.taxi)} />
                    <div className="pt-3 border-t">
                      <DataRow label="Block Fuel" value={formatWeight(ofpData.fuel.plan_ramp)} highlight />
                    </div>
                    <DataRow label="Landing Fuel" value={formatWeight(ofpData.fuel.plan_landing)} muted />
                    <DataRow label="Avg Fuel Flow" value={`${parseInt(ofpData.fuel.avg_fuel_flow || '0').toLocaleString()} kg/hr`} muted />
                  </CardContent>
                </Card>
                
                {/* Weights */}
                <Card className="border-l-4 border-l-blue-500">
                  <CardHeader className="pb-3">
                    <CardTitle className="flex items-center gap-2 text-lg">
                      <Weight className="h-5 w-5 text-blue-500" />
                      Weight Planning
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <DataRow label="OEW" value={formatWeight(ofpData.weights.oew)} />
                    <DataRow label="Passengers" value={ofpData.weights.pax_count || '0'} />
                    <DataRow label="Cargo" value={formatWeight(ofpData.weights.cargo)} />
                    <DataRow label="Payload" value={formatWeight(ofpData.weights.payload)} />
                    <div className="pt-3 border-t">
                      <DataRow label="Est ZFW" value={formatWeight(ofpData.weights.est_zfw)} />
                      <DataRow label="Max ZFW" value={formatWeight(ofpData.weights.max_zfw)} muted />
                    </div>
                    <div className="pt-3 border-t">
                      <DataRow label="Est TOW" value={formatWeight(ofpData.weights.est_tow)} highlight />
                      <DataRow label="Max TOW" value={formatWeight(ofpData.weights.max_tow)} muted />
                    </div>
                    <div className="pt-3 border-t">
                      <DataRow label="Est LDW" value={formatWeight(ofpData.weights.est_ldw)} />
                      <DataRow label="Max LDW" value={formatWeight(ofpData.weights.max_ldw)} muted />
                    </div>
                  </CardContent>
                </Card>
              </div>
            </TabsContent>
            
            {/* Weather Tab */}
            <TabsContent value="weather" className="space-y-6 mt-0">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <MetarWeatherCard 
                  icao={ofpData.origin.icao_code}
                  label="Departure"
                  metar={ofpData.origin.metar || ''}
                  runwayHeading={ofpData.origin.plan_rwy ? parseInt(ofpData.origin.plan_rwy.replace(/[LRC]/g, '')) * 10 : 0}
                />
                
                <MetarWeatherCard 
                  icao={ofpData.destination.icao_code}
                  label="Arrival"
                  metar={ofpData.destination.metar || ''}
                  runwayHeading={ofpData.destination.plan_rwy ? parseInt(ofpData.destination.plan_rwy.replace(/[LRC]/g, '')) * 10 : 0}
                />
              </div>
              
              {/* TAF Data */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {ofpData.origin.taf && (
                  <Card>
                    <CardHeader className="pb-3">
                      <CardTitle className="text-sm flex items-center gap-2">
                        <ThermometerSun className="h-4 w-4" />
                        Departure TAF - {ofpData.origin.icao_code}
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ScrollArea className="h-24">
                        <p className="font-mono text-xs bg-muted/50 p-3 rounded-lg whitespace-pre-wrap">
                          {ofpData.origin.taf}
                        </p>
                      </ScrollArea>
                    </CardContent>
                  </Card>
                )}
                {ofpData.destination.taf && (
                  <Card>
                    <CardHeader className="pb-3">
                      <CardTitle className="text-sm flex items-center gap-2">
                        <ThermometerSun className="h-4 w-4" />
                        Arrival TAF - {ofpData.destination.icao_code}
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <ScrollArea className="h-24">
                        <p className="font-mono text-xs bg-muted/50 p-3 rounded-lg whitespace-pre-wrap">
                          {ofpData.destination.taf}
                        </p>
                      </ScrollArea>
                    </CardContent>
                  </Card>
                )}
              </div>
              
              {/* Alternate Weather */}
              {ofpData.alternate.icao_code && (
                <MetarWeatherCard 
                  icao={ofpData.alternate.icao_code}
                  label="Alternate"
                  metar={ofpData.alternate.metar || ''}
                />
              )}
            </TabsContent>
            
            {/* Navigation Log Tab */}
            <TabsContent value="navlog" className="space-y-6 mt-0">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <List className="h-5 w-5 text-primary" />
                    Navigation Log
                    <Badge variant="secondary" className="ml-2">
                      {ofpData.navlog.length} waypoints
                    </Badge>
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-0">
                  <ScrollArea className="h-[500px]">
                    <div className="overflow-x-auto">
                      <table className="w-full min-w-[900px]">
                        <thead className="sticky top-0 bg-muted/80 backdrop-blur-sm">
                          <tr className="border-b text-xs uppercase text-muted-foreground">
                            <th className="text-left p-3 font-medium">#</th>
                            <th className="text-left p-3 font-medium">Waypoint</th>
                            <th className="text-left p-3 font-medium">Airway</th>
                            <th className="text-left p-3 font-medium">Type</th>
                            <th className="text-right p-3 font-medium">Altitude</th>
                            <th className="text-right p-3 font-medium">Wind</th>
                            <th className="text-right p-3 font-medium">Distance</th>
                            <th className="text-right p-3 font-medium">ETE</th>
                            <th className="text-right p-3 font-medium">Fuel Rem</th>
                          </tr>
                        </thead>
                        <tbody>
                          {ofpData.navlog.length === 0 ? (
                            <tr>
                              <td colSpan={9} className="text-center py-12 text-muted-foreground">
                                No navigation log data available
                              </td>
                            </tr>
                          ) : (
                            ofpData.navlog.map((fix, idx) => (
                              <tr 
                                key={idx} 
                                className={`border-b border-muted/50 hover:bg-muted/30 transition-colors ${
                                  fix.is_sid_star === '1' ? 'bg-primary/5' : ''
                                }`}
                              >
                                <td className="p-3 text-muted-foreground text-sm">{idx + 1}</td>
                                <td className="p-3">
                                  <span className="font-semibold">{fix.ident}</span>
                                  {fix.name && (
                                    <span className="text-xs text-muted-foreground ml-2">{fix.name}</span>
                                  )}
                                </td>
                                <td className="p-3 text-muted-foreground">{fix.via_airway || 'DCT'}</td>
                                <td className="p-3">
                                  <Badge variant="outline" className="text-xs">
                                    {fix.type || 'WPT'}
                                  </Badge>
                                </td>
                                <td className="p-3 text-right font-mono">
                                  FL{Math.round(parseInt(fix.altitude_feet || '0') / 100)}
                                </td>
                                <td className="p-3 text-right text-muted-foreground">
                                  {fix.wind_dir}°/{fix.wind_spd}kt
                                </td>
                                <td className="p-3 text-right">{fix.distance} NM</td>
                                <td className="p-3 text-right text-muted-foreground">
                                  {formatLegTime(fix.time_total)}
                                </td>
                                <td className="p-3 text-right font-mono">
                                  {parseInt(fix.fuel_plan_onboard || '0').toLocaleString()}
                                </td>
                              </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>
                  </ScrollArea>
                </CardContent>
              </Card>
            </TabsContent>
            
            {/* Maps Tab */}
            <TabsContent value="maps" className="space-y-6 mt-0">
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Map className="h-5 w-5 text-primary" />
                    Flight Route Maps
                    <Badge variant="secondary" className="ml-2">
                      {ofpData.images.maps.length} available
                    </Badge>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  {ofpData.images.maps.length === 0 ? (
                    <div className="text-center py-12">
                      <ImageIcon className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
                      <p className="text-muted-foreground">
                        No maps available for this flight plan.
                      </p>
                      <p className="text-sm text-muted-foreground mt-2">
                        Try regenerating the OFP with "Detailed Maps" option enabled.
                      </p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {ofpData.images.maps.map((map, idx) => (
                        <div 
                          key={idx} 
                          className="bg-muted/30 rounded-xl overflow-hidden border hover:border-primary/50 transition-colors"
                        >
                          <div className="p-3 border-b bg-muted/50 flex items-center justify-between">
                            <p className="text-sm font-medium flex items-center gap-2">
                              <Layers className="h-4 w-4 text-primary" />
                              {map.name}
                            </p>
                            <Button 
                              variant="ghost" 
                              size="sm"
                              onClick={() => window.open(map.fullUrl, '_blank')}
                            >
                              <ExternalLink className="h-4 w-4" />
                            </Button>
                          </div>
                          <div className="relative aspect-video bg-muted">
                            {imageErrors[idx] ? (
                              <div className="absolute inset-0 flex flex-col items-center justify-center text-muted-foreground">
                                <ImageIcon className="h-8 w-8 mb-2" />
                                <p className="text-sm">Failed to load map</p>
                                <Button 
                                  variant="link" 
                                  size="sm" 
                                  className="mt-2"
                                  onClick={() => window.open(map.fullUrl, '_blank')}
                                >
                                  Open in new tab
                                </Button>
                              </div>
                            ) : (
                              <img
                                src={map.fullUrl}
                                alt={map.name}
                                className="w-full h-full object-contain"
                                loading="lazy"
                                onError={() => handleImageError(idx)}
                              />
                            )}
                          </div>
                          <div className="p-2">
                            <Button 
                              variant="secondary" 
                              size="sm" 
                              className="w-full"
                              onClick={() => window.open(map.fullUrl, '_blank')}
                            >
                              <Download className="h-4 w-4 mr-2" />
                              Download Full Size
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
              
              {/* PDF Download */}
              {ofpData.files.pdf.link && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <FileText className="h-5 w-5 text-primary" />
                      Documents
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <Button 
                      variant="outline"
                      className="gap-2"
                      onClick={() => window.open(ofpData.files.pdf.link, '_blank')}
                    >
                      <Download className="h-4 w-4" />
                      Download PDF Briefing Package
                    </Button>
                  </CardContent>
                </Card>
              )}
            </TabsContent>
          </Tabs>
          
          {/* Action Buttons */}
          <div className="mt-8 flex flex-wrap gap-4 justify-between items-center pt-6 border-t">
            <Button 
              variant="outline" 
              onClick={() => navigate('/dashboard/ofp-generator')}
              className="gap-2"
            >
              <ArrowLeft className="h-4 w-4" />
              Generate New OFP
            </Button>
            <Button 
              onClick={handleContinueToDeliveries}
              className="gap-2 bg-gradient-to-r from-primary to-primary/80"
            >
              <Plane className="h-4 w-4" />
              Continue to Deliveries
            </Button>
          </div>
        </>
      )}
    </DashboardLayout>
  );
}

// Helper Components
function DataRow({ label, value, highlight, muted }: { label: string; value: string; highlight?: boolean; muted?: boolean }) {
  return (
    <div className="flex items-center justify-between py-1">
      <span className="text-muted-foreground text-sm">{label}</span>
      <span className={`font-medium ${
        highlight ? 'text-primary text-lg font-bold' : 
        muted ? 'text-muted-foreground text-xs' : 
        ''
      }`}>
        {value}
      </span>
    </div>
  );
}

function DataBox({ label, value }: { label: string; value: string }) {
  return (
    <div className="bg-muted/50 rounded-lg p-3 text-center">
      <p className="text-xs text-muted-foreground uppercase mb-1">{label}</p>
      <p className="font-semibold">{value}</p>
    </div>
  );
}

function QuickStatCard({ icon: Icon, label, value, color }: { 
  icon: React.ElementType; 
  label: string; 
  value: string; 
  color: string;
}) {
  return (
    <Card className="overflow-hidden">
      <CardContent className="p-4 flex items-center gap-3">
        <div className={`p-2 rounded-lg bg-muted ${color}`}>
          <Icon className="h-5 w-5" />
        </div>
        <div>
          <p className="text-xs text-muted-foreground">{label}</p>
          <p className="font-bold">{value}</p>
        </div>
      </CardContent>
    </Card>
  );
}

function FlightCategoryBadge({ category }: { category: string }) {
  const colors: Record<string, string> = {
    vfr: 'bg-green-500/20 text-green-600 border-green-500',
    mvfr: 'bg-blue-500/20 text-blue-600 border-blue-500',
    ifr: 'bg-amber-500/20 text-amber-600 border-amber-500',
    lifr: 'bg-red-500/20 text-red-600 border-red-500',
  };
  
  return (
    <Badge 
      variant="outline" 
      className={colors[category?.toLowerCase()] || 'bg-muted text-muted-foreground'}
    >
      {category?.toUpperCase() || 'Unknown'}
    </Badge>
  );
}

function formatLegTime(seconds: string): string {
  if (!seconds) return '0:00';
  const totalMins = Math.round(parseInt(seconds) / 60);
  const hrs = Math.floor(totalMins / 60);
  const mins = totalMins % 60;
  return `${hrs}:${mins.toString().padStart(2, '0')}`;
}
